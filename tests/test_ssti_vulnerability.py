"""
RED test for CWE-1336: Server-Side Template Injection (SSTI) in the 404 error handler.

The vulnerability is in app/app.py line 114, where user input from request.url
is interpolated directly into a Jinja2 template string using Python's % operator
before being passed to render_template_string(). This allows an attacker to inject
Jinja2 template expressions (e.g., {{7*7}}) via the URL, which will be evaluated
server-side.

This RED test asserts the SECURE behavior: that template expressions in URLs should
NOT be evaluated. On the current vulnerable code, the expression {{7*7}} in the URL
will be evaluated to "49", causing the assertion to FAIL — proving the vulnerability.

After fixing the code (e.g., by passing the URL as a template variable instead of
string-formatting it in), the test will PASS because the expression will be rendered
as literal text, not evaluated.
"""
import sys
import os
import pytest

# Add app directory to path so we can import the Flask app
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'app'))

from app import app


@pytest.fixture
def client():
    """Create a Flask test client."""
    app.config['TESTING'] = True
    with app.test_client() as client:
        yield client


class TestSSTIVulnerability:
    """Tests that prove SSTI vulnerability exists in the 404 error handler."""

    def test_404_handler_does_not_evaluate_template_expressions(self, client):
        """
        RED TEST: A secure 404 handler should NOT evaluate Jinja2 expressions
        found in the URL. The expression {{7*7}} should appear literally in the
        response, NOT be evaluated to "49".

        On vulnerable code: {{7*7}} is evaluated to 49 → assertion FAILS
        On fixed code: {{7*7}} is escaped/literal → assertion PASSES
        """
        # Send a request to a non-existent URL containing a Jinja2 expression
        response = client.get('/{{7*7}}')
        response_text = response.data.decode('utf-8')

        # In a secure implementation, the computed value "49" should NOT appear
        # in the response as a standalone evaluated result.
        # The literal string "{{7*7}}" or its URL-encoded form may appear, but
        # the number "49" from evaluating the expression must NOT.
        assert '49' not in response_text, (
            "SSTI VULNERABILITY DETECTED: The Jinja2 template expression {{7*7}} "
            "in the URL was evaluated to '49' by the server. User input in the URL "
            "is being rendered as a template, allowing Server-Side Template Injection."
        )

    def test_404_handler_does_not_evaluate_config_access(self, client):
        """
        RED TEST: A secure 404 handler should NOT allow access to Flask config
        via template injection. An attacker should not be able to extract the
        SECRET_KEY through the URL.

        On vulnerable code: config values are leaked → assertion FAILS
        On fixed code: expression is literal → assertion PASSES
        """
        # Try to access Flask's secret key through SSTI
        response = client.get('/{{config.SECRET_KEY_HMAC}}')
        response_text = response.data.decode('utf-8')

        # The actual secret value "secret" should NOT appear as evaluated output
        # This proves config data exfiltration is possible
        assert 'secret' not in response_text.lower() or '{{config' in response_text, (
            "SSTI VULNERABILITY DETECTED: The Jinja2 template expression "
            "{{config.SECRET_KEY_HMAC}} was evaluated, leaking the secret key. "
            "This allows attackers to exfiltrate sensitive configuration data."
        )

"""
RED Test: Server-Side Template Injection (SSTI) via render_template_string
CWE-1336: Improper Neutralization of Special Elements Used in a Template Engine

This test proves that the 404 error handler in app/app.py is vulnerable to SSTI.
The handler uses Python string formatting (% operator) to embed `request.url` directly
into a Jinja2 template string before passing it to `render_template_string()`.

An attacker can craft a URL containing Jinja2 template expressions like {{7*7}},
which will be evaluated server-side, potentially leading to Remote Code Execution.

SECURE behavior: Template injection payloads in the URL should be rendered as literal
text, NOT evaluated. The URL "{{7*7}}" should appear as "{{7*7}}" in the response,
NOT as "49".

This test FAILS on the vulnerable code because the template expression IS evaluated,
meaning "49" appears in the output instead of the literal "{{7*7}}".
"""

import pytest
from flask import Flask, render_template_string, request


def create_vulnerable_app():
    """
    Recreates the exact vulnerable pattern from app/app.py lines 102-114.
    This isolates the vulnerability without needing the full app's database setup.
    """
    app = Flask(__name__)

    @app.errorhandler(404)
    def pnf(e):
        # This is the exact vulnerable code from app/app.py line 102-114
        template = '''<html>
        <head>
        <title>Error</title>
        </head>
        <body>
        <h1>Oops that page doesn't exist!!</h1>
        <h3>%s</h3>
        </body>
        </html>
        ''' % request.url

        return render_template_string(template, dir=dir, help=help, locals=locals), 404

    return app


class TestSSTIVulnerability:
    """Tests that the 404 handler is protected against Server-Side Template Injection."""

    @pytest.fixture
    def client(self):
        app = create_vulnerable_app()
        app.config['TESTING'] = True
        with app.test_client() as client:
            yield client

    def test_template_expression_not_evaluated_in_404_response(self, client):
        """
        SECURITY ASSERTION: Jinja2 template expressions in URLs must NOT be evaluated.

        When a user visits a URL containing {{7*7}}, the 404 page should display
        the literal text "{{7*7}}", NOT the computed result "49".

        This test FAILS on vulnerable code because {{7*7}} is evaluated to 49,
        proving Server-Side Template Injection is possible.
        """
        # Send a request with a Jinja2 template injection payload in the URL
        response = client.get('/{{7*7}}')
        body = response.data.decode('utf-8')

        # The response should NOT contain "49" as a result of template evaluation.
        # In secure code, {{7*7}} would be treated as literal text, not evaluated.
        assert '49' not in body, (
            "SSTI VULNERABILITY DETECTED: The Jinja2 expression {{7*7}} in the URL "
            "was evaluated to '49' in the 404 error page. This proves that user input "
            "is being processed as a Jinja2 template, enabling Server-Side Template Injection. "
            "An attacker could use this to execute arbitrary code on the server."
        )

    def test_template_tags_rendered_as_literal_text(self, client):
        """
        SECURITY ASSERTION: Template syntax in URLs should appear as literal text.

        The URL path should be displayed as-is in the error page without any
        template processing of its contents.
        """
        response = client.get('/{{config}}')
        body = response.data.decode('utf-8')

        # If the config object is dumped into the response, SSTI is confirmed.
        # In secure code, the literal text "{{config}}" should appear instead.
        assert 'SECRET_KEY' not in body and 'Config' not in body, (
            "SSTI VULNERABILITY DETECTED: The Jinja2 expression {{config}} in the URL "
            "caused the Flask configuration to be leaked in the 404 error page. "
            "This confirms Server-Side Template Injection with information disclosure."
        )
